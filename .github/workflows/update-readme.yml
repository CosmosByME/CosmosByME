name: Update README - currently & quote
on:
  schedule:
    # daily run at 03:00 UTC (adjust if you want)
    - cron: '0 3 * * *'
  workflow_dispatch:
  push:
    branches:
      - main
      - master

permissions:
  contents: write
  metadata: read

jobs:
  update-readme:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          persist-credentials: true

      - name: Set up Node (used by github-script)
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Compose currently & quote and update README.md
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const username = context.actor === 'github-actions' ? process.env.GITHUB_REPOSITORY.split('/')[0] : context.actor;
            // 1) list repos for the user and find the most recently pushed repo
            const repos = await github.paginate(github.rest.repos.listForUser, {
              username,
              per_page: 100
            });

            // Filter out forks and archived repos, then sort by pushed_at
            const userRepos = repos
              .filter(r => !r.fork && !r.archived)
              .sort((a,b) => new Date(b.pushed_at) - new Date(a.pushed_at));

            let latestRepo = userRepos.length ? userRepos[0] : null;

            // If there's no user repo (unlikely), fallback to the repo this action runs in
            if (!latestRepo) {
              const parts = process.env.GITHUB_REPOSITORY.split('/');
              latestRepo = await github.rest.repos.get({
                owner: parts[0],
                repo: parts[1]
              }).then(r => r.data);
            }

            // Prepare readable time
            function timeAgo(iso) {
              if(!iso) return 'unknown';
              const diff = (Date.now() - new Date(iso).getTime()) / 1000;
              if (diff < 60) return Math.floor(diff) + 's ago';
              if (diff < 3600) return Math.floor(diff/60) + 'm ago';
              if (diff < 86400) return Math.floor(diff/3600) + 'h ago';
              return Math.floor(diff/86400) + 'd ago';
            }

            // 2) fetch the latest commit for that repo (default branch)
            let commitMsg = '';
            let commitDate = '';
            try {
              const shaResp = await github.rest.repos.getCommit({
                owner: latestRepo.owner.login,
                repo: latestRepo.name,
                ref: latestRepo.default_branch
              });
              commitMsg = (shaResp && shaResp.data && shaResp.data.commit && shaResp.data.commit.message) ? shaResp.data.commit.message.split('\n')[0] : '';
              commitDate = (shaResp && shaResp.data && shaResp.data.commit && shaResp.data.commit.author && shaResp.data.commit.author.date) || latestRepo.pushed_at || '';
            } catch (e) {
              // fallback: try listing commits
              try {
                const commits = await github.rest.repos.listCommits({
                  owner: latestRepo.owner.login,
                  repo: latestRepo.name,
                  per_page: 1
                });
                if (commits.data && commits.data.length) {
                  commitMsg = commits.data[0].commit.message.split('\n')[0];
                  commitDate = commits.data[0].commit.author.date;
                }
              } catch (err) {
                commitMsg = '';
                commitDate = latestRepo.pushed_at || '';
              }
            }

            // 3) get quote from quotable.io (random)
            let quoteText = '"We are a way for the universe to know itself." â€” Carl Sagan';
            try {
              const fetch = require('node-fetch');
              const qresp = await fetch('https://api.quotable.io/random?tags=wisdom|science|famous-quotes');
              if (qresp.ok) {
                const qj = await qresp.json();
                if (qj.content && qj.author) quoteText = `"${qj.content}" â€” ${qj.author}`;
              }
            } catch (err) {
              // keep default
            }

            // 4) Prepare the new snippet
            const newSnippet = `<!-- START_SECTION:currently -->\n\nðŸ› ï¸ **Currently Working On**  \n\n**Latest repo:** [${latestRepo.name}](${latestRepo.html_url})  \n**Last updated:** ${timeAgo(commitDate)}  \n**Commit:** ${commitMsg ? commitMsg : '(no commit message)'}  \n\n**Space Quote:**  \n> ${quoteText}\n\n<!-- END_SECTION:currently -->`;

            // 5) Fetch the README.md file content
            const readmePath = 'README.md';
            const readmeResp = await github.rest.repos.getContent({
              owner: context.repo.owner,
              repo: context.repo.repo,
              path: readmePath
            });

            const buff = Buffer.from(readmeResp.data.content, readmeResp.data.encoding);
            const readmeContent = buff.toString('utf8');

            // 6) Replace the section between markers
            const startMarker = '<!-- START_SECTION:currently -->';
            const endMarker = '<!-- END_SECTION:currently -->';

            let newReadme;
            if (readmeContent.includes(startMarker) && readmeContent.includes(endMarker)) {
              const before = readmeContent.split(startMarker)[0];
              const after = readmeContent.split(endMarker)[1];
              newReadme = `${before}${newSnippet}${after}`;
            } else {
              // If markers do not exist, append snippet at end
              newReadme = `${readmeContent}\n\n${newSnippet}`;
            }

            // 7) Commit the updated README.md back to repo (only if changed)
            if (newReadme !== readmeContent) {
              await github.rest.repos.createOrUpdateFileContents({
                owner: context.repo.owner,
                repo: context.repo.repo,
                path: readmePath,
                message: 'chore(readme): update currently working on & space quote',
                content: Buffer.from(newReadme, 'utf8').toString('base64'),
                sha: readmeResp.data.sha,
                committer: {
                  name: "github-actions[bot]",
                  email: "41898282+github-actions[bot]@users.noreply.github.com"
                },
                author: {
                  name: context.actor,
                  email: `${context.actor}@users.noreply.github.com`
                }
              });
              core.info('README.md updated with latest "Currently Working On" info.');
            } else {
              core.info('No changes detected in README.md â€” skipping commit.');
            }

